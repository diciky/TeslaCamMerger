<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç‰¹æ–¯æ‹‰è¡Œè½¦è®°å½•ä»ªè§†é¢‘åˆå¹¶</title>
    <link rel="stylesheet" href="index.css">
</head>

<body>
    <div class="app-layout">
        <!-- å·¦ä¾§å¯¼èˆªæ  -->
        <aside class="sidebar">
            <div class="tesla-logo" onclick="location.reload()">
                <svg viewBox="0 0 350 40" fill="currentColor">
                    <!-- TESLA Wordmark -->
                    <g transform="scale(0.08) translate(-200, -380)">
                        <path
                            d="m28.524 388.986c0.812 3.167 3.554 6.404 7.316 7.215h11.37l0.58 0.229v28.691h7.1v-28.691l0.645-0.229h11.38c3.804-0.98 6.487-4.048 7.285-7.215v-0.07h-45.676v0.07" />
                        <path
                            d="m98.795 425.202h27.011c3.758-0.747 6.551-4.058 7.334-7.263h-41.679c0.778 3.206 3.612 6.516 7.334 7.263" />
                        <path
                            d="m98.795 410.485h27.011c3.758-0.741 6.551-4.053 7.334-7.262h-41.679c0.778 3.21 3.612 6.521 7.334 7.262" />
                        <path
                            d="m98.795 396.163h27.011c3.758-0.749 6.551-4.058 7.334-7.265h-41.679c0.778 3.207 3.612 6.516 7.334 7.265" />
                        <path
                            d="m160.398 396.094h24.954c3.762-1.093 6.921-3.959 7.691-7.136h-39.64v21.415h32.444v7.515l-25.449 0.02c-3.988 1.112-7.37 3.79-9.057 7.327l2.062-0.038h39.415v-21.944h-32.42v-7.159" />
                        <path
                            d="m245.319 425.206c3.543-1.502 5.449-4.1 6.179-7.14h-31.517l0.02-29.118-7.065 0.02v36.238h32.383" />
                        <path
                            d="m272.845 396.192h27.02c3.753-0.746 6.544-4.058 7.331-7.262h-41.681c0.779 3.205 3.611 6.516 7.330 7.262" />
                        <path d="m266.601 403.28v21.912h7.027v-14.589h25.575v14.589h7.022v-21.874l-39.624-0.038" />
                    </g>
                    <!-- T Symbol -->
                    <path transform="scale(0.06) translate(400, -50)"
                        d="M 173.146,317.299 208.622,117.78 c 33.815,0 44.481,3.708 46.021,18.843 0,0 22.684,-8.458 34.125,-25.636 C 244.122,90.299 199.263,89.366 199.263,89.366 l -26.176,31.882 0.059,-0.004 -26.176,-31.883 c 0,0 -44.86,0.934 -89.5,21.622 11.431,17.178 34.124,25.636 34.124,25.636 1.549,-15.136 12.202,-18.844 45.79,-18.868 l 35.762,199.548" />
                    <path transform="scale(0.06) translate(400, -50)"
                        d="m 173.132,80.157 c 36.09,-0.276 77.399,5.583 119.687,24.014 5.652,-10.173 7.105,-14.669 7.105,-14.669 C 253.697,71.213 210.406,64.954 173.127,64.797 135.85,64.954 92.561,71.214 46.34,89.502 c 0,0 2.062,5.538 7.1,14.669 42.28,-18.431 83.596,-24.29 119.687,-24.014 h 0.005" />
                </svg>
            </div>
            <nav class="nav-menu">
                <div class="nav-item active" id="nav-browser">
                    <div class="icon-wrap"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M22 19a2 2 0 01-2 2H4a2 2 0 01-2-2V5a2 2 0 012-2h5l2 3h9a2 2 0 012 2z"></path>
                        </svg></div>
                    <span>æ–‡ä»¶æµè§ˆå™¨</span>
                </div>
                <div class="nav-item" onclick="openPicker('source-path')">
                    <div class="icon-wrap"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path
                                d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4">
                            </path>
                        </svg></div>
                    <span>åˆå¹¶è®¾ç½®</span>
                </div>
                <div class="nav-item" onclick="alert('å†å²åŠŸèƒ½æ­£åœ¨å¼€å‘ä¸­...')">
                    <div class="icon-wrap"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"></circle>
                            <polyline points="12 6 12 12 16 14"></polyline>
                        </svg></div>
                    <span>å†å²è®°å½•</span>
                </div>
                <div class="nav-item" onclick="alert('è´¦æˆ·åŠŸèƒ½æ­£åœ¨å¼€å‘ä¸­...')">
                    <div class="icon-wrap"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"></path>
                            <circle cx="12" cy="7" r="4"></circle>
                        </svg></div>
                    <span>è´¦æˆ·</span>
                </div>
            </nav>
            <div class="sidebar-bottom">
                <div class="logo-t">
                    <svg viewBox="0 0 350 350" fill="currentColor">
                        <path
                            d="M 173.146,317.299 208.622,117.78 c 33.815,0 44.481,3.708 46.021,18.843 0,0 22.684,-8.458 34.125,-25.636 C 244.122,90.299 199.263,89.366 199.263,89.366 l -26.176,31.882 0.059,-0.004 -26.176,-31.883 c 0,0 -44.86,0.934 -89.5,21.622 11.431,17.178 34.124,25.636 34.124,25.636 1.549,-15.136 12.202,-18.844 45.79,-18.868 l 35.762,199.548" />
                        <path
                            d="m 173.132,80.157 c 36.09,-0.276 77.399,5.583 119.687,24.014 5.652,-10.173 7.105,-14.669 7.105,-14.669 C 253.697,71.213 210.406,64.954 173.127,64.797 135.85,64.954 92.561,71.214 46.34,89.502 c 0,0 2.062,5.538 7.1,14.669 42.28,-18.431 83.596,-24.29 119.687,-24.014 h 0.005" />
                    </svg>
                </div>
            </div>
        </aside>

        <!-- ä¸»å†…å®¹åŒº -->
        <main class="main-content">
            <header class="top-header">
                <div class="neon-title-wrap">
                    <h1 class="neon-title">ç‰¹æ–¯æ‹‰è¡Œè½¦è®°å½•ä»ªè§†é¢‘åˆå¹¶</h1>
                </div>
                <div class="top-controls">
                    <button class="icon-btn" onclick="addLog('æš‚æ— æ–°é€šçŸ¥', 'system')"><svg viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2">
                            <path d="M18 8A6 6 0 006 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
                            <path d="M13.73 21a2 2 0 01-3.46 0"></path>
                        </svg><span class="badge"></span></button>
                    <button class="icon-btn" onclick="openPicker('source-path')"><svg viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="3"></circle>
                            <path
                                d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-2 2 2 2 0 01-2-2v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83 0 2 2 0 010-2.83l.06-.06a1.65 1.65 0 00.33-1.82 1.65 1.65 0 00-1.51-1V11a2 2 0 01-2-2 2 2 0 012-2v-.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00.33-1.82l.06-.06a2 2 0 010-2.83 2 2 0 012.83 0l.06.06a1.65 1.65 0 001.82.33H9a1.65 1.65 0 001-1.51V3a2 2 0 012-2 2 2 0 012 2v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 0 2 2 0 010 2.83l-.06.06a1.65 1.65 0 00-.33 1.82V9a1.65 1.65 0 001.51 1H21a2 2 0 012 2 2 2 0 01-2 2v.09a1.65 1.65 0 00-1.51 1z">
                            </path>
                        </svg></button>
                    <button class="icon-btn" onclick="alert('æ›´å¤šé€‰é¡¹...')"><svg viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="1"></circle>
                            <circle cx="19" cy="12" r="1"></circle>
                            <circle cx="5" cy="12" r="1"></circle>
                        </svg></button>
                </div>
            </header>

            <div class="content-area">
                <div class="glass-container">
                    <div class="panel-header">
                        <span class="active-tab">TeslaCam èµ„æºé¢„è§ˆ</span>
                        <div class="panel-meta">
                            <label><input type="checkbox" id="setting-auto-merge"> è‡ªåŠ¨é‡è¿</label>
                        </div>
                    </div>

                    <div class="path-display-bar">
                        <div class="path-chip" onclick="openPicker('source-path')">
                            <small>æºè·¯å¾„:</small> <span id="source-path-label">/Volumes/TESLADRIVE/TeslaCam</span>
                        </div>
                        <div class="path-chip" onclick="openPicker('output-path')">
                            <small>è¾“å‡ºè·¯å¾„:</small> <span id="output-path-label">/Volumes/TESLADRIVE/TeslaCam</span>
                        </div>
                        <div class="path-chip">
                            <small>ç›®æ ‡æ—¥æœŸ:</small>
                            <div class="tesla-datepicker" id="tesla-datepicker">
                                <div class="datepicker-value" onclick="toggleCalendar()">å…¨éƒ¨æ—¥æœŸ</div>
                                <div class="datepicker-calendar" id="datepicker-calendar">
                                    <div class="calendar-header">
                                        <button onclick="changeMonth(-1); event.stopPropagation()">&lt;</button>
                                        <span id="calendar-month-year">2023å¹´12æœˆ</span>
                                        <button onclick="changeMonth(1); event.stopPropagation()">&gt;</button>
                                    </div>
                                    <div class="calendar-weekdays">
                                        <span>æ—¥</span><span>ä¸€</span><span>äºŒ</span><span>ä¸‰</span><span>å››</span><span>äº”</span><span>å…­</span>
                                    </div>
                                    <div class="calendar-days" id="calendar-days"></div>
                                </div>
                            </div>
                        </div>
                        <input type="hidden" id="selected-date" value="">
                        <input type="hidden" id="source-path" value="/Volumes/TESLADRIVE/TeslaCam">
                        <input type="hidden" id="output-path" value="/Volumes/TESLADRIVE/TeslaCam">
                    </div>

                    <div class="video-grid" id="video-grid">
                        <div class="placeholder-msg">æ­£åœ¨æ‰«ææºç›®å½•ä»¥é¢„è§ˆè§†é¢‘...</div>
                    </div>

                    <!-- è§†é¢‘é€‰æ‹©ä¸è¯¦ç»†åˆ—è¡¨ (NEW) -->
                    <div id="video-selection-area" class="video-selection-area" style="display: none;">
                        <div class="selection-header">
                            <span class="selection-title"><span id="selection-date-label"></span> è§†é¢‘åˆ†ç‰‡ (å…± <span
                                    id="total-clips-count">0</span> ä¸ª)</span>
                            <div class="selection-controls">
                                <label class="checkbox-label">
                                    <input type="checkbox" id="select-all-checkbox" checked
                                        onchange="toggleSelectAll()"> å…¨é€‰
                                </label>
                            </div>
                        </div>
                        <div class="video-list-container" id="video-list-container">
                            <!-- åŠ¨æ€ç”Ÿæˆè§†é¢‘åˆ—è¡¨ -->
                        </div>
                    </div>

                    <!-- Floating Progress Card -->
                    <div id="progress-container" class="floating-card progress-card" style="display: none;">
                        <div class="card-header">
                            <span class="card-title">è§†é¢‘å¤„ç†ä¸­...</span>
                            <span id="progress-percent" class="card-value">0%</span>
                        </div>
                        <div class="progress-bar-container">
                            <div id="progress-bar" class="progress-bar-fill"></div>
                        </div>
                        <!-- è¯¦ç»†å­ä»»åŠ¡åŒºåŸŸ -->
                        <div id="sub-tasks-header" class="sub-tasks-header" onclick="toggleSubTasks()">
                            <span>è¯¦ç»†ä»»åŠ¡çŠ¶æ€</span>
                            <i id="toggle-icon" class="fas fa-chevron-down"></i>
                        </div>
                        <div id="sub-tasks-list" class="sub-tasks-list">
                            <!-- åŠ¨æ€ç”Ÿæˆçš„å­ä»»åŠ¡è¿›åº¦å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ -->
                        </div>
                        <div id="progress-detail" class="card-footer">å‡†å¤‡å¤„ç†ä»»åŠ¡...</div>
                    </div>

                    <div class="bottom-actions">
                        <!-- ç§»é™¤å°‘é‡æ–‡ä»¶æµ‹è¯•å¼€å…³ -->
                        <button id="start-btn" class="tesla-btn">å¼€å§‹åˆå¹¶</button>
                        <button id="stop-btn" class="tesla-btn secondary" disabled>åœæ­¢</button>
                    </div>
                </div>
            </div>

            <!-- ç»ˆç«¯æ—¥å¿—çª—å£ -->
            <div class="log-window">
                <div class="log-header">
                    <span>Log console</span>
                    <div class="window-btns"><span onclick="clearLog()"></span><span></span><span></span></div>
                </div>
                <div class="log-content" id="log-console">
                    <div class="log-line system">ç³»ç»Ÿå°±ç»ªï¼Œç­‰å¾…æŒ‡ä»¤...</div>
                </div>
            </div>
        </main>
    </div>

    <!-- æ–‡ä»¶å¤¹é€‰æ‹©å™¨å¼¹çª— -->
    <div id="picker-modal" class="modal">
        <div class="modal-content glass">
            <div class="modal-header">
                <h3>é€‰æ‹©æ–‡ä»¶å¤¹</h3>
                <button class="close-btn" onclick="closePicker()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="current-path-bar">
                    <button onclick="goParent()" id="up-btn">..</button>
                    <span id="current-display">/</span>
                </div>
                <div id="folder-list" class="folder-list"></div>
            </div>
            <div class="modal-footer">
                <button class="tesla-btn secondary small" onclick="closePicker()">å–æ¶ˆ</button>
                <button class="tesla-btn small" onclick="confirmPicker()">ç¡®å®š</button>
            </div>
        </div>
    </div>

    <!-- è§†é¢‘æ’­æ”¾å™¨å¼¹çª— -->
    <div id="video-modal" class="modal">
        <div class="modal-content glass video-player-content">
            <div class="modal-header">
                <h3 id="video-modal-title">è§†é¢‘é¢„è§ˆ</h3>
                <button class="close-btn" onclick="closeVideoPlayer()">&times;</button>
            </div>
            <div class="video-wrapper">
                <video id="preview-player" controls autoplay>
                    æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè§†é¢‘æ’­æ”¾ã€‚
                </video>
            </div>
        </div>
    </div>

    <script>
        const startBtn = document.getElementById('start-btn');
        const stopBtn = document.getElementById('stop-btn');
        const sourceInput = document.getElementById('source-path');
        const outputInput = document.getElementById('output-path');
        const progressContainer = document.getElementById('progress-container');
        const progressBar = document.getElementById('progress-bar');
        const progressPercent = document.getElementById('progress-percent');
        const statusTitle = document.getElementById('status-title');
        const progressDetail = document.getElementById('progress-detail');
        const logConsole = document.getElementById('log-console');
        const videoGrid = document.getElementById('video-grid');

        let currentTargetId = '';
        let currentPath = '/';
        let eventSource = null;

        function addLog(msg, type = '') {
            if (msg.startsWith("PROGRESS:")) return;
            const item = document.createElement('div');
            item.className = 'log-line ' + (type || '');
            item.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
            logConsole.appendChild(item);
            logConsole.scrollTop = logConsole.scrollHeight;
        }

        let availableDates = [];
        let calendarDate = new Date();
        let selectedDate = "";

        // Video Selection Global State
        let currentVideoList = [];
        let selectedTimestamps = new Set();

        async function updateDateList(path) {
            try {
                const resp = await fetch(`/api/dates?path=${encodeURIComponent(path)}`);
                const data = await resp.json();
                availableDates = data.dates || [];
                renderCalendar();
            } catch (e) {
                console.error("åŠ è½½æ—¥æœŸå¤±è´¥:", e);
            }
        }

        function toggleCalendar() {
            const cal = document.getElementById('datepicker-calendar');
            const isVisible = cal.style.display === 'block';
            cal.style.display = isVisible ? 'none' : 'block';
            if (!isVisible) renderCalendar();
        }

        function renderCalendar() {
            const year = calendarDate.getFullYear();
            const month = calendarDate.getMonth();
            document.getElementById('calendar-month-year').textContent = `${year}å¹´${month + 1}æœˆ`;

            const firstDay = new Date(year, month, 1).getDay();
            const lastDate = new Date(year, month + 1, 0).getDate();
            const daysGrid = document.getElementById('calendar-days');
            daysGrid.innerHTML = '';

            // å…¨éƒ¨æ—¥æœŸé€‰é¡¹
            const allOpt = document.createElement('div');
            allOpt.className = 'calendar-day-item full-width' + (selectedDate === "" ? " active" : "");
            allOpt.textContent = "å…¨éƒ¨æ—¥æœŸ (å…¨é‡åˆå¹¶)";
            allOpt.onclick = (e) => { e.stopPropagation(); selectDate(""); };
            daysGrid.appendChild(allOpt);

            for (let i = 0; i < firstDay; i++) {
                daysGrid.appendChild(document.createElement('div'));
            }

            for (let d = 1; d <= lastDate; d++) {
                const dayEl = document.createElement('div');
                dayEl.className = 'calendar-day-item';
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;

                if (availableDates.includes(dateStr)) {
                    dayEl.classList.add('has-data');
                }
                if (selectedDate === dateStr) {
                    dayEl.classList.add('active');
                }

                dayEl.textContent = d;
                dayEl.onclick = (e) => {
                    e.stopPropagation();
                    if (availableDates.includes(dateStr)) {
                        selectDate(dateStr);
                    }
                };
                daysGrid.appendChild(dayEl);
            }
        }

        function changeMonth(delta) {
            calendarDate.setMonth(calendarDate.getMonth() + delta);
            renderCalendar();
        }

        function selectDate(date) {
            selectedDate = date;
            document.getElementById('selected-date').value = date;
            document.querySelector('.datepicker-value').textContent = date || "å…¨éƒ¨æ—¥æœŸ";
            document.getElementById('datepicker-calendar').style.display = 'none';
            renderCalendar();

            // éšè—é€šç”¨é¢„è§ˆï¼Œæ˜¾ç¤ºç‰¹å®šæ—¥æœŸçš„è§†é¢‘é€‰æ‹©åŒº
            if (date) {
                document.getElementById('video-grid').style.display = 'none';
                document.getElementById('video-selection-area').style.display = 'block';
                fetchVideosForDate(date);
            } else {
                document.getElementById('video-grid').style.display = 'grid';
                document.getElementById('video-selection-area').style.display = 'none';
                fetchPreview();
            }
        }

        async function fetchVideosForDate(date) {
            const path = sourceInput.value;
            const container = document.getElementById('video-list-container');
            container.innerHTML = '<div class="placeholder-msg">æ­£åœ¨åŠ è½½è§†é¢‘åˆ—è¡¨...</div>';

            try {
                const resp = await fetch(`/api/videos?date=${date}&path=${encodeURIComponent(path)}`);
                const data = await resp.json();

                if (data.status === 'success') {
                    currentVideoList = data.videos;
                    selectedTimestamps = new Set(currentVideoList.map(v => v.timestamp)); // é»˜è®¤å…¨é€‰
                    document.getElementById('total-clips-count').textContent = currentVideoList.length;
                    document.getElementById('selection-date-label').textContent = date; // Update date label
                    document.getElementById('select-all-checkbox').checked = true;
                    renderVideoList();
                } else {
                    container.innerHTML = `<div class="placeholder-msg error">${data.message}</div>`;
                }
            } catch (e) {
                container.innerHTML = '<div class="placeholder-msg error">åŠ è½½å¤±è´¥</div>';
            }
        }

        function renderVideoList() {
            const container = document.getElementById('video-list-container');
            container.innerHTML = '';

            if (currentVideoList.length === 0) {
                container.innerHTML = '<div class="placeholder-msg">è¯¥æ—¥æœŸä¸‹æ²¡æœ‰æ‰¾åˆ°è§†é¢‘æ–‡ä»¶</div>';
                return;
            }

            currentVideoList.forEach(video => {
                const item = document.createElement('div');
                item.className = 'video-list-item ' + (selectedTimestamps.has(video.timestamp) ? 'selected' : '');

                // æ ¼å¼åŒ–æ—¶é—´æˆ³æ˜¾ç¤º HH:MM:SS
                const timeLabel = video.timestamp.split('_')[1].replace(/-/g, ':');
                const isSelected = selectedTimestamps.has(video.timestamp);

                item.innerHTML = `
                    <div class="video-item-check">
                        <input type="checkbox" id="cb-${video.timestamp}" ${isSelected ? 'checked' : ''}>
                    </div>
                    <div class="video-item-info" onclick="toggleSelection('${video.timestamp}')">
                        <span class="video-time">${timeLabel}</span>
                        <span class="video-cameras">æ‘„åƒå¤´: ${video.cameras.join(', ')}</span>
                    </div>
                    <div class="video-item-preview">
                        <button class="icon-btn-small" onclick="playVideo('${video.preview_path}', '${video.timestamp}')">
                            â–¶ é¢„è§ˆ
                        </button>
                    </div>
                `;

                // ç»‘å®š checkbox äº‹ä»¶
                const cb = item.querySelector('input[type="checkbox"]');
                cb.onchange = (e) => {
                    if (e.target.checked) selectedTimestamps.add(video.timestamp);
                    else selectedTimestamps.delete(video.timestamp);
                    updateSelectAllState();
                    renderVideoList(); // é‡æ–°æ¸²æŸ“ä»¥æ›´æ–°æ ·å¼
                };

                container.appendChild(item);
            });
        }

        function toggleSelection(ts) {
            const cb = document.getElementById(`cb-${ts}`);
            cb.click();
        }

        function updateSelectAllState() {
            const allChecked = currentVideoList.length > 0 && selectedTimestamps.size === currentVideoList.length;
            document.getElementById('select-all-checkbox').checked = allChecked;
        }

        function toggleSelectAll() {
            const isChecked = document.getElementById('select-all-checkbox').checked;
            if (isChecked) {
                selectedTimestamps = new Set(currentVideoList.map(v => v.timestamp));
            } else {
                selectedTimestamps.clear();
            }
            renderVideoList();
        }

        function playVideo(path, ts) {
            const modal = document.getElementById('video-modal');
            const player = document.getElementById('preview-player');
            const title = document.getElementById('video-modal-title');

            title.textContent = `é¢„è§ˆ: ${ts}`;
            // ä½¿ç”¨ /api/stream æ¥å£
            player.src = `/api/stream?path=${encodeURIComponent(path)}`;
            modal.style.display = 'flex';
        }

        function closeVideoPlayer() {
            const modal = document.getElementById('video-modal');
            const player = document.getElementById('preview-player');
            player.pause();
            player.src = '';
            modal.style.display = 'none';
        }

        function clearLog() {
            logConsole.innerHTML = '<div class="log-line system">æ—¥å¿—å·²æ¸…ç©º...</div>';
        }

        async function startTask() {
            const source_path = sourceInput.value;
            const output_path = outputInput.value;
            const target_date = document.getElementById('selected-date').value;
            // è·å–é€‰ä¸­çš„æ—¶é—´æˆ³åˆ—è¡¨ (å¦‚æœä¸æ˜¯å…¨é‡åˆå¹¶æ¨¡å¼)
            let target_timestamps = null;
            if (target_date && selectedTimestamps.size > 0 && selectedTimestamps.size < currentVideoList.length) {
                target_timestamps = Array.from(selectedTimestamps);
            }
            // å¦‚æœæ˜¯å…¨é€‰çŠ¶æ€ï¼Œæˆ–è€…æ²¡æœ‰é€‰æ‹©æ—¥æœŸï¼Œåˆ™ target_timestamps ä¿æŒ nullï¼Œåç«¯ä¼šè‡ªåŠ¨å¤„ç†

            let logMsg = "æ­£åœ¨å¯åŠ¨åˆå¹¶ä»»åŠ¡...";
            if (target_date) {
                logMsg += ` [æŒ‡å®šæ—¥æœŸ: ${target_date}]`;
                if (target_timestamps) {
                    logMsg += ` [é€‰ä¸­ ${target_timestamps.length} ä¸ªç‰¹å®šç‰‡æ®µ]`;
                } else {
                    logMsg += ` [å…¨é‡ ${selectedTimestamps.size} ä¸ªç‰‡æ®µ]`;
                }
            }

            addLog(logMsg, "system");
            startBtn.disabled = true;

            try {
                const resp = await fetch('/api/start', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        source_path,
                        output_path,
                        sample_limit: null, // ç§»é™¤æ—§çš„æµ‹è¯•é™åˆ¶
                        target_date: target_date || null,
                        target_timestamps: target_timestamps
                    })
                });
                const data = await resp.json();

                if (data.status === 'success') {
                    stopBtn.disabled = false;
                    progressContainer.style.display = 'block';
                    initSSE();
                } else {
                    addLog(data.message, 'error');
                    startBtn.disabled = false;
                }
            } catch (err) {
                addLog('æ— æ³•è¿æ¥åç«¯é€»è¾‘ç«¯å£', 'error');
                startBtn.disabled = false;
            }
        }

        async function stopTask() {
            if (confirm("ç¡®å®šè¦åœæ­¢ä»»åŠ¡å—ï¼Ÿ")) {
                await fetch('/api/stop', { method: 'POST' });
                addLog('å·²å‘é€åœæ­¢æŒ‡ä»¤', 'warning');
                stopBtn.disabled = true;
            }
        }

        function initSSE() {
            if (eventSource) eventSource.close();
            eventSource = new EventSource('/api/events');

            eventSource.onmessage = (e) => {
                const msg = e.data;
                if (msg.startsWith("PROGRESS:")) {
                    const parts = msg.split(':');
                    const percentRaw = parts[1] || '0%';
                    const percent = percentRaw.includes('%') ? percentRaw : percentRaw + '%';
                    const detailFull = parts[2] || '';

                    progressBar.style.width = percent;
                    progressPercent.textContent = percent;
                    progressContainer.style.display = 'block';

                    const detailParts = detailFull.split(';');
                    const mainStatus = detailParts[0];
                    progressDetail.textContent = mainStatus;

                    const subTasksList = document.getElementById('sub-tasks-list');
                    if (detailParts.length > 1) {
                        const activeTasks = detailParts.slice(1);
                        updateSubTasks(activeTasks);
                    } else {
                        subTasksList.innerHTML = '<div class="sub-task-item empty">ç­‰å¾…æ–°ä»»åŠ¡...</div>';
                    }

                    if (mainStatus.includes("å®Œæˆ") || mainStatus.includes("å¤±è´¥")) {
                        addLog(msg);
                    }
                } else if (msg.startsWith("COMPLETED:")) {
                    addLog(msg, 'success');
                    startBtn.disabled = false;
                    stopBtn.disabled = true;
                    setTimeout(() => { progressContainer.style.display = 'none'; }, 5000);
                    eventSource.close();
                    eventSource = null;
                } else if (msg.includes("Error") || msg.includes("Failed")) {
                    addLog(msg, 'error');
                } else {
                    addLog(msg);
                }
            };

            eventSource.onerror = () => {
                if (eventSource) {
                    eventSource.close();
                    eventSource = null;
                    setTimeout(initSSE, 3000);
                }
            };
        }

        function updateSubTasks(activeTasks) {
            const listEl = document.getElementById('sub-tasks-list');
            listEl.innerHTML = '';

            if (activeTasks.length === 0) {
                listEl.innerHTML = '<div class="sub-task-item empty">ç­‰å¾…æ–°ä»»åŠ¡...</div>';
                return;
            }

            activeTasks.forEach(task => {
                const name = task.includes(': ') ? task.split(': ')[1] : task.replace('ğŸ”¥ æ­£åœ¨å¤„ç†: ', '');
                const item = document.createElement('div');
                item.className = 'sub-task-item active';
                item.innerHTML = `
                    <div class="sub-task-info">
                        <span class="task-icon">ğŸï¸</span>
                        <span class="task-name">${name}</span>
                        <span class="task-type">ç¡¬ä»¶è½¬ç ä¸­</span>
                    </div>
                    <div class="sub-task-bar">
                        <div class="sub-task-fill"></div>
                    </div>
                `;
                listEl.appendChild(item);
            });
        }

        function toggleSubTasks() {
            const list = document.getElementById('sub-tasks-list');
            const icon = document.getElementById('toggle-icon');
            list.classList.toggle('show');
            icon.style.transform = list.classList.contains('show') ? 'rotate(180deg)' : 'rotate(0deg)';
        }

        async function fetchPreview() {
            const path = sourceInput.value;
            // document.getElementById('source-path-label').textContent = path;
            document.getElementById('output-path-label').textContent = outputInput.value;

            try {
                const resp = await fetch(`/api/preview?path=${encodeURIComponent(path)}`);
                const data = await resp.json();
                if (data.status === 'success') {
                    videoGrid.innerHTML = '';
                    if (data.files.length === 0) {
                        videoGrid.innerHTML = '<div class="placeholder-msg">è¯¥ç›®å½•ä¸‹æš‚æ—  mp4 å½•åƒæ–‡ä»¶</div>';
                        return;
                    }
                    data.files.forEach(f => {
                        const card = document.createElement('div');
                        card.className = 'video-card';
                        card.innerHTML = `
                            <div class="video-thumb"><div class="vid-icon">ğŸ¬</div></div>
                            <div class="video-info">
                                <span>${f.name.substring(0, 16)}...</span>
                                <span>${f.size}</span>
                            </div>
                        `;
                        videoGrid.appendChild(card);
                    });
                }
            } catch (e) {
                videoGrid.innerHTML = '<div class="placeholder-msg">é¢„è§ˆåŠŸèƒ½è¿æ¥å¤±è´¥</div>';
            }
        }

        function openPicker(targetId) {
            currentTargetId = targetId;
            currentPath = document.getElementById(targetId).value || '/';
            document.getElementById('picker-modal').style.display = 'flex';
            loadFolders(currentPath);
        }

        function closePicker() {
            document.getElementById('picker-modal').style.display = 'none';
        }

        function confirmPicker() {
            const val = currentPath;
            document.getElementById(currentTargetId).value = val;
            const labelEl = document.getElementById(currentTargetId + '-label');
            if (labelEl) labelEl.textContent = val;
            if (currentTargetId === 'source-path') {
                updateDateList(val);
            }
            closePicker();
            fetchPreview();
        }

        async function loadFolders(path) {
            const listEl = document.getElementById('folder-list');
            const displayEl = document.getElementById('current-display');
            listEl.innerHTML = '<div class="log-line">Loading...</div>';
            displayEl.textContent = path;

            try {
                const resp = await fetch(`/api/ls?path=${encodeURIComponent(path)}`);
                const data = await resp.json();
                if (data.status === 'success') {
                    currentPath = data.current;
                    listEl.innerHTML = '';
                    if (data.parent) {
                        const up = document.createElement('div');
                        up.className = 'folder-item parent';
                        up.innerHTML = '<span>ğŸ“ .. (è¿”å›ä¸Šä¸€çº§)</span>';
                        up.onclick = () => loadFolders(data.parent);
                        listEl.appendChild(up);
                    }
                    data.items.forEach(item => {
                        const div = document.createElement('div');
                        div.className = 'folder-item';
                        div.innerHTML = `<span>ğŸ“ ${item.name}</span>`;
                        div.onclick = () => loadFolders(item.path);
                        listEl.appendChild(div);
                    });
                }
            } catch (e) {
                listEl.innerHTML = '<div class="log-line error">æ— æ³•åŠ è½½ç›®å½•</div>';
            }
        }

        function goParent() {
            const parts = currentPath.split('/');
            if (parts.length > 2) {
                parts.pop();
                loadFolders(parts.join('/') || '/');
            } else if (parts.length === 2 && parts[1] !== '') {
                loadFolders('/');
            }
        }

        startBtn.onclick = startTask;
        stopBtn.onclick = stopTask;

        async function checkStatus() {
            try {
                const resp = await fetch('/api/status');
                const data = await resp.json();
                if (data.logs && data.logs.length > 0) {
                    logConsole.innerHTML = '';
                    data.logs.forEach(l => {
                        const div = document.createElement('div');
                        div.className = 'log-line';
                        if (l.includes('Successfully') || l.includes('COMPLETED')) div.classList.add('success');
                        if (l.includes('Error') || l.includes('Failed')) div.classList.add('error');
                        if (l.includes('Scanning') || l.includes('Processing') || l.includes('PROGRESS')) div.classList.add('system');
                        div.textContent = l;
                        logConsole.appendChild(div);
                    });
                    logConsole.scrollTop = logConsole.scrollHeight;
                }
                if (data.is_running) {
                    startBtn.disabled = true;
                    stopBtn.disabled = false;
                    progressContainer.style.display = 'block';
                    const prog = data.progress + (String(data.progress).includes('%') ? '' : '%');
                    progressBar.style.width = prog;
                    progressPercent.textContent = prog;
                    initSSE();
                }
            } catch (e) { }
        }

        // ç‚¹å‡»é¡µé¢å…¶ä»–ä½ç½®å…³é—­æ—¥å†
        document.addEventListener('click', (e) => {
            const datepicker = document.getElementById('tesla-datepicker');
            const calendar = document.getElementById('datepicker-calendar');
            if (!datepicker.contains(e.target)) {
                calendar.style.display = 'none';
            }
        });

        checkStatus();
        fetchPreview();
        updateDateList(sourceInput.value);
        // Init Output Label
        document.getElementById('output-path-label').textContent = outputInput.value;
        // --- Log Window Draggable Logic ---
        (function initLogDraggable() {
            const logWindow = document.querySelector('.log-window');
            const logHeader = document.querySelector('.log-header');
            let isDragging = false;
            let startX, startY, initialTop, initialRight;

            logHeader.style.cursor = 'move';

            logHeader.addEventListener('mousedown', (e) => {
                isDragging = true;
                startX = e.clientX;
                startY = e.clientY;

                // è·å–å½“å‰è®¡ç®—å‡ºçš„æ ·å¼å€¼
                const rect = logWindow.getBoundingClientRect();
                initialTop = rect.top;
                // å› ä¸º CSS ä½¿ç”¨äº† right: 40pxï¼Œæˆ‘ä»¬è¿™é‡Œæ”¹ä¸ºä½¿ç”¨ absolute å®šä½æ¥è·Ÿéš
                // ä½†ä¸ºäº†ä¿æŒåŸæœ‰çš„å“åº”å¼ï¼Œæˆ‘ä»¬æ‰‹åŠ¨æ›´æ–° top å’Œ right
                initialRight = window.innerWidth - rect.right;

                logWindow.style.opacity = '0.7';
                logWindow.style.transition = 'none'; // ç§»åŠ¨æ—¶å…³é—­å¹³æ»‘è¿‡æ¸¡

                document.addEventListener('mousemove', onMouseMove);
                document.addEventListener('mouseup', onMouseUp);
            });

            function onMouseMove(e) {
                if (!isDragging) return;

                const dx = e.clientX - startX;
                const dy = e.clientY - startY;

                const newTop = initialTop + dy;
                const newRight = initialRight - dx;

                logWindow.style.top = `${newTop}px`;
                logWindow.style.right = `${newRight}px`;
                logWindow.style.bottom = 'auto'; // ç¡®ä¿ bottom ä¸ä¼šå†²çª
            }

            function onMouseUp() {
                isDragging = false;
                logWindow.style.opacity = '1';
                logWindow.style.transition = '';
                document.removeEventListener('mousemove', onMouseMove);
                document.removeEventListener('mouseup', onMouseUp);
            }
        })();
    </script>
</body>

</html>