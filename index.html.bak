<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÁâπÊñØÊãâË°åËΩ¶ËÆ∞ÂΩï‰ª™ËßÜÈ¢ëÂêàÂπ∂</title>
    <link rel="stylesheet" href="index.css">
</head>

<body>
    <div class="app-layout">
        <!-- Â∑¶‰æßÂØºËà™Ê†è -->
        <aside class="sidebar">
            <div class="tesla-logo">
                <svg viewBox="0 0 342 35" fill="currentColor">
                    <path
                        d="M0 .1a9.7 9.7 0 0 1 7 7h11l.5.1V5.1c0-1.2.6-2 1.5-2.6L34 0h-8.2c-1.3 0-2.3.4-3 1.3L15.4 12V4.1c0-1.3.6-2.4 1.5-3.1L30 0h-23C6 0 5 1.1 5 3.3v15H0v.1z">
                    </path>
                    <path d="M46.9 0l-23 1h23c2.2 0 3.3 1 3.3 3.3V19h5V0h-8.3z"></path>
                    <path d="M67 19h5V0h-5c-2.2 0-3.3 1-3.3 3.3V19h-5V0h5.3z"></path>
                    <path d="M102.3 0h-23c-1.3 0-2.3.4-3 1.3l-10.3 10.7V4.1c0-1.3.6-2.4 1.5-3.1L82 0h23z"></path>
                    <path d="M113.8 0h-23c-1.3 0-2.3.4-3 1.3L77.5 12V4.1c0-1.3.6-2.4 1.5-3.1L93 0h23z"></path>
                    <path d="M147.7 0h-23c-1.3 0-2.3.4-3 1.3l-10.3 10.7V4.1c0-1.3.6-2.4 1.5-3.1L127 0h23z"></path>
                </svg>
            </div>
            <nav class="nav-menu">
                <div class="nav-item active">
                    <div class="icon-wrap"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M22 19a2 2 0 01-2 2H4a2 2 0 01-2-2V5a2 2 0 012-2h5l2 3h9a2 2 0 012 2z"></path>
                        </svg></div>
                    <span>Êñá‰ª∂ÊµèËßàÂô®</span>
                </div>
                <div class="nav-item" onclick="openPicker('source-path')">
                    <div class="icon-wrap"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path
                                d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4">
                            </path>
                        </svg></div>
                    <span>ÂêàÂπ∂ËÆæÁΩÆ</span>
                </div>
                <div class="nav-item">
                    <div class="icon-wrap"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"></circle>
                            <polyline points="12 6 12 12 16 14"></polyline>
                        </svg></div>
                    <span>ÂéÜÂè≤ËÆ∞ÂΩï</span>
                </div>
                <div class="nav-item">
                    <div class="icon-wrap"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"></path>
                            <circle cx="12" cy="7" r="4"></circle>
                        </svg></div>
                    <span>Ë¥¶Êà∑</span>
                </div>
            </nav>
            <div class="sidebar-bottom">
                <div class="logo-t">
                    <svg viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12 2L4.5 20.29L5.21 21L12 18L18.79 21L19.5 20.29L12 2Z" />
                    </svg>
                </div>
            </div>
        </aside>

        <!-- ‰∏ªÂÜÖÂÆπÂå∫ -->
        <main class="main-content">
            <header class="top-header">
                <div class="neon-title-wrap">
                    <h1 class="neon-title">ÁâπÊñØÊãâË°åËΩ¶ËÆ∞ÂΩï‰ª™ËßÜÈ¢ëÂêàÂπ∂</h1>
                </div>
                <div class="top-controls">
                    <button class="icon-btn"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <path d="M18 8A6 6 0 006 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
                            <path d="M13.73 21a2 2 0 01-3.46 0"></path>
                        </svg><span class="badge"></span></button>
                    <button class="icon-btn"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <circle cx="12" cy="12" r="3"></circle>
                            <path
                                d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-2 2 2 2 0 01-2-2v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83 0 2 2 0 010-2.83l.06-.06a1.65 1.65 0 00.33-1.82 1.65 1.65 0 00-1.51-1V11a2 2 0 01-2-2 2 2 0 012-2v-.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00.33-1.82l.06-.06a2 2 0 010-2.83 2 2 0 012.83 0l.06.06a1.65 1.65 0 001.82.33H9a1.65 1.65 0 001-1.51V3a2 2 0 012-2 2 2 0 012 2v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 0 2 2 0 010 2.83l-.06.06a1.65 1.65 0 00-.33 1.82V9a1.65 1.65 0 001.51 1H21a2 2 0 012 2 2 2 0 01-2 2v.09a1.65 1.65 0 00-1.51 1z">
                            </path>
                        </svg></button>
                    <button class="icon-btn"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <circle cx="12" cy="12" r="1"></circle>
                            <circle cx="19" cy="12" r="1"></circle>
                            <circle cx="5" cy="12" r="1"></circle>
                        </svg></button>
                </div>
            </header>

            <div class="content-area">
                <div class="glass-container">
                    <div class="panel-header">
                        <span class="active-tab">TeslaCam</span>
                        <div class="panel-meta">
                            <label><input type="checkbox" checked> ÂêàÂπ∂ËÆæÁΩÆ</label>
                        </div>
                    </div>

                    <!-- Ë∑ØÂæÑËÆæÁΩÆ (ÈöêËóèÂú®ÈΩøËΩÆÊàñÁõ¥Êé•Â±ïÁ§∫‰ª•‰æøÊìç‰Ωú) -->
                    <div class="path-inputs">
                        <input type="text" id="source-path" value="/Volumes/TESLADRIVE/TeslaCam" readonly
                            onclick="openPicker('source-path')">
                        <input type="text" id="output-path" value="/Users/diciky/cam" readonly
                            onclick="openPicker('output-path')">
                    </div>

                    <div class="video-grid">
                        <div class="video-card">
                            <div class="video-thumb"><img
                                    src="https://images.unsplash.com/photo-1541447271487-09612b3f49f7?w=400&q=80"
                                    alt="demo"></div>
                            <div class="video-info">
                                <span>2023-05-25 11:32</span>
                                <span>1.8 MB</span>
                            </div>
                        </div>
                        <div class="video-card">
                            <div class="video-thumb"><img
                                    src="https://images.unsplash.com/photo-1517649763962-0c623066013b?w=400&q=80"
                                    alt="demo"></div>
                            <div class="video-info">
                                <span>2023-05-25 14:26</span>
                                <span>1.3 MB</span>
                            </div>
                        </div>
                        <div class="video-card">
                            <div class="video-thumb"><img
                                    src="https://images.unsplash.com/photo-1506744038136-46273834b3fb?w=400&q=80"
                                    alt="demo"></div>
                            <div class="video-info">
                                <span>2023-05-25 15:20</span>
                                <span>2.2 MB</span>
                            </div>
                        </div>
                        <div class="video-card">
                            <div class="video-thumb"><img
                                    src="https://images.unsplash.com/photo-1449034446853-66c86144b0ad?w=400&q=80"
                                    alt="demo"></div>
                            <div class="video-info">
                                <span>2023-05-30 08:12</span>
                                <span>4.5 MB</span>
                            </div>
                        </div>
                    </div>

                    <!-- ÊµÆÂä®ËøõÂ∫¶Âç°Áâá -->
                    <div class="floating-progress" id="progress-container">
                        <h2 id="status-title">ËßÜÈ¢ëÂêàÂπ∂‰∏≠... <span id="progress-percent">0%</span></h2>
                        <div class="progress-bar-wrap">
                            <div class="progress-bar" id="progress-bar">
                                <div class="progress-glow"></div>
                            </div>
                        </div>
                    </div>

                    <div class="bottom-actions">
                        <button id="start-btn" class="tesla-btn">ÂºÄÂßãÂêàÂπ∂</button>
                        <button id="stop-btn" class="tesla-btn secondary" disabled>ÂÅúÊ≠¢</button>
                    </div>
                </div>
            </div>

            <!-- ÁªàÁ´ØÊó•ÂøóÁ™óÂè£ -->
            <div class="log-window">
                <div class="log-header">
                    <span>Log console</span>
                    <div class="window-btns"><span></span><span></span><span></span></div>
                </div>
                <div class="log-content" id="log-console">
                    <div class="log-line success">Á≥ªÁªüÂ∞±Áª™ÔºåÁ≠âÂæÖÊåá‰ª§...</div>
                </div>
            </div>
        </main>
    </div>

    <!-- Êñá‰ª∂Â§πÈÄâÊã©Âô®ÂºπÁ™ó -->
    <div id="picker-modal" class="modal">
        <div class="modal-content glass">
            <div class="modal-header">
                <h3>ÈÄâÊã©Êñá‰ª∂Â§π</h3>
                <button class="close-btn" onclick="closePicker()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="current-path-bar">
                    <button onclick="goParent()" id="up-btn">..</button>
                    <span id="current-display">/</span>
                </div>
                <div id="folder-list" class="folder-list"></div>
            </div>
            <div class="modal-footer">
                <button class="tesla-btn secondary small" onclick="closePicker()">ÂèñÊ∂à</button>
                <button class="tesla-btn small" onclick="confirmPicker()">Á°ÆÂÆö</button>
            </div>
        </div>
    </div>

    <script>
        const startBtn = document.getElementById('start-btn');
        const stopBtn = document.getElementById('stop-btn');
        const sourceInput = document.getElementById('source-path');
        const outputInput = document.getElementById('output-path');
        const progressContainer = document.getElementById('progress-container');
        const progressBar = document.getElementById('progress-bar');
        const progressPercent = document.getElementById('progress-percent');
        const statusTitle = document.getElementById('status-title');
        const logConsole = document.getElementById('log-console');

        let currentTargetId = '';
        let currentPath = '/';
        let eventSource = null;

        function addLog(msg, type = '') {
            if (msg.startsWith("PROGRESS:")) return;
            const item = document.createElement('div');
            item.className = 'log-line ' + type;
            item.textContent = msg;
            logConsole.appendChild(item);
            logConsole.scrollTop = logConsole.scrollHeight;
        }

        async function startTask() {
            try {
                const resp = await fetch('/api/start', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        source_path: sourceInput.value,
                        output_path: outputInput.value
                    })
                });
                const data = await resp.json();
                if (data.status === 'success') {
                    startBtn.disabled = true;
                    stopBtn.disabled = false;
                    initSSE();
                } else {
                    addLog(data.message, 'error');
                }
            } catch (err) {
                addLog('Êó†Ê≥ïËøûÊé•Âà∞ÂêéÁ´ØÊúçÂä°Âô®', 'error');
            }
        }

        async function stopTask() {
            await fetch('/api/stop', { method: 'POST' });
            addLog('Ê≠£Âú®ÂÅúÊ≠¢‰ªªÂä°...', 'warning');
            stopBtn.disabled = true;
        }

        function initSSE() {
            if (eventSource) eventSource.close();
            eventSource = new EventSource('/api/events');
            eventSource.onmessage = (e) => {
                const msg = e.data;
                if (msg.startsWith("PROGRESS:")) {
                    const parts = msg.split(':');
                    const percent = parts[1];
                    const info = parts[2];
                    progressBar.style.width = percent;
                    progressPercent.textContent = percent;
                    statusTitle.firstChild.textContent = `ËßÜÈ¢ëÂêàÂπ∂‰∏≠... `;
                } else if (msg.startsWith("COMPLETED:")) {
                    addLog(msg, 'success');
                    startBtn.disabled = false;
                    stopBtn.disabled = true;
                    eventSource.close();
                } else {
                    addLog(msg, msg.includes('Error') ? 'error' : '');
                }
            };
        }

        // Picker Logic
        function openPicker(targetId) {
            currentTargetId = targetId;
            currentPath = document.getElementById(targetId).value || '/';
            document.getElementById('picker-modal').style.display = 'flex';
            loadFolders(currentPath);
        }

        function closePicker() {
            document.getElementById('picker-modal').style.display = 'none';
        }

        function confirmPicker() {
            document.getElementById(currentTargetId).value = currentPath;
            closePicker();
        }

        async function loadFolders(path) {
            const listEl = document.getElementById('folder-list');
            const displayEl = document.getElementById('current-display');
            listEl.innerHTML = '<div class="log-line">Loading...</div>';
            displayEl.textContent = path;

            try {
                const resp = await fetch(`/api/ls?path=${encodeURIComponent(path)}`);
                const data = await resp.json();
                if (data.status === 'success') {
                    currentPath = data.current;
                    listEl.innerHTML = '';
                    data.items.forEach(item => {
                        const div = document.createElement('div');
                        div.className = 'folder-item';
                        div.innerHTML = `<span>üìÅ</span> <span>${item.name}</span>`;
                        div.onclick = () => loadFolders(item.path);
                        listEl.appendChild(div);
                    });
                    document.getElementById('up-btn').onclick = () => data.parent && loadFolders(data.parent);
                }
            } catch (e) { }
        }

        startBtn.onclick = startTask;
        stopBtn.onclick = stopTask;
    </script>
</body>

</html>