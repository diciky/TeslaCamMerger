name: Build Windows App

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Download FFmpeg
      shell: pwsh
      run: |
        Invoke-WebRequest -Uri "https://www.gyan.dev/ffmpeg/builds/ffmpeg-release-essentials.zip" -OutFile "ffmpeg.zip"
        Expand-Archive -Path "ffmpeg.zip" -DestinationPath "ffmpeg_temp"
        $ffmpegExe = Get-ChildItem -Path "ffmpeg_temp" -Filter "ffmpeg.exe" -Recurse | Select-Object -First 1
        $ffprobeExe = Get-ChildItem -Path "ffmpeg_temp" -Filter "ffprobe.exe" -Recurse | Select-Object -First 1
        Copy-Item $ffmpegExe.FullName -Destination "."
        Copy-Item $ffprobeExe.FullName -Destination "."
        Remove-Item -Recurse -Force "ffmpeg_temp"
        Remove-Item "ffmpeg.zip"

    - name: Convert Icon to ICO
      run: |
        python -c "from PIL import Image; img = Image.open('icon.png'); img.save('icon.ico', sizes=[(16,16), (32,32), (48,48), (64,64), (128,128), (256,256)])"

    - name: Build with PyInstaller
      run: |
        python -m PyInstaller --noconfirm --windowed --name "TeslaCamMerger" `
          --icon "icon.ico" `
          --add-data "index.html;." `
          --add-data "index.css;." `
          --add-binary "ffmpeg.exe;." `
          --add-binary "ffprobe.exe;." `
          --hidden-import "uvicorn" `
          --hidden-import "webview" `
          --hidden-import "uvicorn.logging" `
          --hidden-import "uvicorn.loops" `
          --hidden-import "uvicorn.loops.auto" `
          --hidden-import "uvicorn.protocols" `
          --hidden-import "uvicorn.protocols.http" `
          --hidden-import "uvicorn.protocols.http.auto" `
          --hidden-import "uvicorn.protocols.websockets" `
          --hidden-import "uvicorn.protocols.websockets.auto" `
          --hidden-import "uvicorn.lifespan" `
          --hidden-import "uvicorn.lifespan.on" `
          "backend.py"

    - name: Archive Production Artifact
      uses: actions/upload-artifact@v4
      with:
        name: TeslaCamMerger_Windows
        path: dist/TeslaCamMerger
