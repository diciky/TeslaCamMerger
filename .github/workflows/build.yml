name: Build Multi-Platform Apps

on:
  push:
    branches: [ main ]
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Download FFmpeg (Windows)
      shell: pwsh
      run: |
        Invoke-WebRequest -Uri "https://www.gyan.dev/ffmpeg/builds/ffmpeg-release-essentials.zip" -OutFile "ffmpeg.zip"
        Expand-Archive -Path "ffmpeg.zip" -DestinationPath "ffmpeg_temp"
        $ffmpegExe = Get-ChildItem -Path "ffmpeg_temp" -Filter "ffmpeg.exe" -Recurse | Select-Object -First 1
        $ffprobeExe = Get-ChildItem -Path "ffmpeg_temp" -Filter "ffprobe.exe" -Recurse | Select-Object -First 1
        Copy-Item $ffmpegExe.FullName -Destination "."
        Copy-Item $ffprobeExe.FullName -Destination "."
        Remove-Item -Recurse -Force "ffmpeg_temp"
        Remove-Item "ffmpeg.zip"

    - name: Convert Icon to ICO
      run: |
        python -c "from PIL import Image; img = Image.open('icon.png'); img.save('icon.ico', sizes=[(16,16), (32,32), (48,48), (64,64), (128,128), (256,256)])"

    - name: Build Windows App with PyInstaller
      run: |
        python -m PyInstaller --noconfirm --windowed --name "TeslaCamMerger" `
          --icon "icon.ico" `
          --add-data "index.html;." `
          --add-data "index.css;." `
          --add-binary "ffmpeg.exe;." `
          --add-binary "ffprobe.exe;." `
          --hidden-import "uvicorn" `
          --hidden-import "webview" `
          --hidden-import "uvicorn.logging" `
          --hidden-import "uvicorn.loops" `
          --hidden-import "uvicorn.loops.auto" `
          --hidden-import "uvicorn.protocols" `
          --hidden-import "uvicorn.protocols.http" `
          --hidden-import "uvicorn.protocols.http.auto" `
          --hidden-import "uvicorn.protocols.websockets" `
          --hidden-import "uvicorn.protocols.websockets.auto" `
          --hidden-import "uvicorn.lifespan" `
          --hidden-import "uvicorn.lifespan.on" `
          "backend.py"

    - name: Zip Windows App
      shell: pwsh
      run: |
        Compress-Archive -Path "dist/TeslaCamMerger" -DestinationPath "TeslaCamMerger_Windows.zip"

    - name: Archive Windows Artifact
      uses: actions/upload-artifact@v4
      with:
        name: TeslaCamMerger_Windows
        path: TeslaCamMerger_Windows.zip

  build-macos:
    runs-on: macos-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'

    - name: Install dependencies
      run: |
        python3 -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Install FFmpeg (macOS)
      run: |
        brew install ffmpeg
        cp $(which ffmpeg) .
        cp $(which ffprobe) .

    - name: Build macOS App & DMG
      run: |
        chmod +x build_app.sh
        ./build_app.sh

    - name: Archive macOS Artifact (DMG)
      uses: actions/upload-artifact@v4
      with:
        name: TeslaCamMerger_macOS_DMG
        path: dist/*.dmg

  release:
    needs: [build-windows, build-macos]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
    - name: Download Windows Artifact
      uses: actions/download-artifact@v4
      with:
        name: TeslaCamMerger_Windows

    - name: Download macOS Artifact
      uses: actions/download-artifact@v4
      with:
        name: TeslaCamMerger_macOS_DMG

    - name: Set Release Version
      id: version
      shell: bash
      run: |
        if [[ "${{ github.ref }}" == refs/tags/* ]]; then
          REF_NAME="${{ github.ref }}"
          echo "tag=${REF_NAME#refs/tags/}" >> $GITHUB_OUTPUT
        else
          echo "tag=v0.1.${{ github.run_number }}" >> $GITHUB_OUTPUT
        fi

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ steps.version.outputs.tag }}
        name: TeslaCam Merger ${{ steps.version.outputs.tag }}
        files: |
          TeslaCamMerger_Windows.zip
          *.dmg
        generate_release_notes: true
        draft: false
        prerelease: false
